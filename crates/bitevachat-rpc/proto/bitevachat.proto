syntax = "proto3";
package bitevachat;

// ---------------------------------------------------------------------------
// MessageService -- send and query messages
// ---------------------------------------------------------------------------

service MessageService {
  rpc SendMessage(SendMessageRequest) returns (SendMessageResponse);
  rpc ListMessages(ListMessagesRequest) returns (ListMessagesResponse);
  rpc GetMessage(GetMessageRequest) returns (GetMessageResponse);
}

// ---------------------------------------------------------------------------
// ContactService -- alias, block, unblock
// ---------------------------------------------------------------------------

service ContactService {
  rpc AddContact(AddContactRequest) returns (AddContactResponse);
  rpc BlockContact(BlockContactRequest) returns (BlockContactResponse);
  rpc UnblockContact(UnblockContactRequest) returns (UnblockContactResponse);
  rpc ListContacts(ListContactsRequest) returns (ListContactsResponse);
}

// ---------------------------------------------------------------------------
// NodeService -- status, peers, shutdown, inject
// ---------------------------------------------------------------------------

service NodeService {
  rpc GetStatus(GetStatusRequest) returns (NodeStatusResponse);
  rpc ListPeers(ListPeersRequest) returns (ListPeersResponse);
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);
  rpc InjectMessage(InjectMessageRequest) returns (InjectMessageResponse);
}

// ---------------------------------------------------------------------------
// ProfileService -- profile management (no private key exposure)
// ---------------------------------------------------------------------------

service ProfileService {
  rpc GetProfile(GetProfileRequest) returns (GetProfileResponse);
  rpc UpdateProfile(UpdateProfileRequest) returns (UpdateProfileResponse);
  rpc GetAvatar(GetAvatarRequest) returns (GetAvatarResponse);
}

// ===========================================================================
// Message types
// ===========================================================================

message SendMessageRequest {
  string recipient = 1;
  bytes plaintext = 2;
  string payload_type = 3;
  bytes shared_key = 4;
}

message SendMessageResponse {
  string message_id = 1;
}

message ListMessagesRequest {
  string convo_id = 1;
  uint64 limit = 2;
  uint64 offset = 3;
}

message ListMessagesResponse {
  repeated MessageInfo messages = 1;
}

message GetMessageRequest {
  string message_id = 1;
}

message GetMessageResponse {
  MessageInfo message = 1;
}

message MessageInfo {
  string message_id = 1;
  string sender = 2;
  string recipient = 3;
  string timestamp = 4;
  string payload_type = 5;
  bytes payload_ciphertext = 6;
}

// ----- ContactService messages --------------------------------------------

message AddContactRequest {
  string address = 1;
  string alias = 2;
}
message AddContactResponse {}

message BlockContactRequest {
  string address = 1;
}
message BlockContactResponse {}

message UnblockContactRequest {
  string address = 1;
}
message UnblockContactResponse {}

message ListContactsRequest {}

message ContactEntry {
  string address = 1;
  string alias = 2;
  bool blocked = 3;
}

message ListContactsResponse {
  repeated ContactEntry contacts = 1;
}

// ----- NodeService messages -----------------------------------------------

message GetStatusRequest {}

message NodeStatusResponse {
  string state = 1;
  string address = 2;
  string peer_id = 3;
  string node_id = 4;
  repeated string listeners = 5;
  uint64 pending_count = 6;
}

message ListPeersRequest {}

message PeerEntry {
  string peer_id = 1;
  string node_id = 2;
}

message ListPeersResponse {
  repeated PeerEntry peers = 1;
}

message ShutdownRequest {}
message ShutdownResponse {}

message InjectMessageRequest {
  bytes canonical_message = 1;
  bytes signature = 2;
  bytes sender_pubkey = 3;
}

message InjectMessageResponse {
  string message_id = 1;
}

// ----- ProfileService messages --------------------------------------------

message GetProfileRequest {
  string address = 1;
}

message GetProfileResponse {
  bool found = 1;
  ProfileInfo profile = 2;
}

message ProfileInfo {
  string address = 1;
  string name = 2;
  string bio = 3;
  string avatar_cid = 4;
  string timestamp = 5;
  uint64 version = 6;
}

message UpdateProfileRequest {
  string name = 1;
  string bio = 2;
  bytes avatar = 3;
  bool remove_avatar = 4;
}

message UpdateProfileResponse {
  string avatar_cid = 1;
  uint64 version = 2;
}

message GetAvatarRequest {
  string cid = 1;
}

message GetAvatarResponse {
  bool found = 1;
  bytes data = 2;
}
